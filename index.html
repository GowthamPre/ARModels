<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>CRAFTFORCELOUNGE</title>
<link rel="icon" href="favicon.jpg" type="image/x-icon">

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 20px;
    color: #333;
  }

  h1, h2 {
    color: #222;
  }

  label {
    display: block;
    margin: 10px 0 5px;
    font-weight: 600;
  }

  input[type="text"],
  input[type="password"],
  input[type="file"] {
    width: 100%;
    max-width: 400px;
    padding: 8px 10px;
    margin-bottom: 10px;
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 14px;
    box-sizing: border-box;
  }

  button {
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    font-weight: 600;
    transition: background 0.2s;
    margin-right: 5px;
  }

  button:hover {
    background-color: #0056b3;
  }

  hr {
    border: 0;
    border-top: 1px solid #ddd;
    margin: 20px 0;
  }

  #assetList {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .asset {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 10px;
    display: flex;
    align-items: center;
    width: 100%;
    max-width: 400px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s;
  }

  .asset:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }

  .asset img {
    width: 50px;
    height: 50px;
    object-fit: contain;
    margin-right: 10px;
    border: 1px solid #eee;
    border-radius: 6px;
    background: #fafafa;
  }

  .asset strong {
    flex-grow: 1;
    margin-right: 10px;
  }

  .asset a {
    text-decoration: none;
    color: #007bff;
    margin-right: 5px;
  }

  .asset a:hover {
    text-decoration: underline;
  }

  #totalItems {
    font-weight: bold;
  }

  /* Responsive adjustments */
  @media (max-width: 500px) {
    .asset {
      flex-direction: column;
      align-items: flex-start;
    }

    .asset img {
      margin-bottom: 8px;
    }

    .asset button {
      margin-top: 5px;
    }
  }

  /* Drag & drop highlight */
  .drag-over {
    background-color: #e0f0ff !important;
  }
</style>
</head>
<body>

 <img src="favicon.jpg" alt="">

<h1>AR Asset Manager</h1>

<!-- Settings -->
<label>GitHub Username: <input id="username"></label>
<label>Repository Name: <input id="repo"></label>
<label>Branch: <input id="branch" value="main"></label>
<label>Personal Access Token: <input id="token" type="password"></label>
<button onclick="saveSettings()">Save Settings</button>
<hr>

<!-- Upload form -->
<div id="dropArea" style="border: 2px dashed #007bff; padding: 20px; max-width: 400px; text-align: center; border-radius: 8px; background: #f9f9f9;">
  Drag & drop model (.fbx/.glb) and icon (.png) here
  <br>or
  <label style="display:inline-block; margin-top: 10px;">
    Select Files: 
    <input id="modelFile" type="file" accept=".fbx,.glb">
    <input id="iconFile" type="file" accept=".png">
  </label>
</div>
<br>
<button onclick="uploadFiles()">Upload</button>
<hr>

<!-- Asset list -->
<h2>Current Assets</h2>
<div id="assetList">Loading...</div>
<p>Total items: <span id="totalItems">0</span></p>

<script>
let settings = {};
let editingAsset = null;

function saveSettings(){
  settings.username = document.getElementById('username').value;
  settings.repo = document.getElementById('repo').value;
  settings.branch = document.getElementById('branch').value;
  settings.token = document.getElementById('token').value;
  localStorage.setItem('arSettings', JSON.stringify(settings));
  loadAssets();
}

function loadSettings(){
  let saved = localStorage.getItem('arSettings');
  if(saved) settings = JSON.parse(saved);
  document.getElementById('username').value = settings.username || '';
  document.getElementById('repo').value = settings.repo || '';
  document.getElementById('branch').value = settings.branch || 'main';
  document.getElementById('token').value = settings.token || '';
}

async function loadAssets(){
  if(!settings.username || !settings.repo) return;
  let apiUrl = `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/models?ref=${settings.branch}`;
  let res = await fetch(apiUrl);
  let files = await res.json();
  let list = document.getElementById('assetList');
  list.innerHTML = '';
  let counter = 0;

  for(let f of files){
    if(!f.name.endsWith('.fbx') && !f.name.endsWith('.glb')) continue;
    counter++;
    let nameBase = f.name.replace(/\.(fbx|glb)$/,'');
    let iconUrl = `https://raw.githubusercontent.com/${settings.username}/${settings.repo}/${settings.branch}/icons/${nameBase}.png`;
    let modelUrl = f.download_url;

    let div = document.createElement('div');
    div.className = 'asset';
    div.innerHTML = `
      <strong>${counter}. ${nameBase}</strong>
      <img src="${iconUrl}" onerror="this.src='';">
      (<a href="${modelUrl}" target="_blank">model</a>)
      <button onclick="editAsset('${nameBase}')">Edit</button>
      <button onclick="deleteAsset('${nameBase}', '${f.name}')">Delete</button>
    `;
    list.appendChild(div);
  }
  document.getElementById('totalItems').innerText = counter;
}

async function uploadFiles(existingName=''){
  let modelFile = document.getElementById('modelFile').files[0];
  let iconFile = document.getElementById('iconFile').files[0];
  if(!modelFile || !iconFile) { alert("Select both files"); return; }

  let nameBase = modelFile.name.replace(/\.(fbx|glb)$/,'');
  if(!iconFile.name.startsWith(nameBase)) { 
    alert("Icon filename must match model filename"); return; 
  }

  // If editing, delete old files first
  if(existingName && existingName !== nameBase){
    await deleteAsset(existingName, existingName + getFileExtension(existingName));
  }

  await uploadFileToGitHub(`models/${modelFile.name}`, modelFile);
  await uploadFileToGitHub(`icons/${iconFile.name}`, iconFile);
  await updateManifest(); // Add this line
  alert("Uploaded successfully!");
  loadAssets();
}

function getFileExtension(filename){
  return filename.endsWith('.fbx') ? '.fbx' : '.glb';
}

async function deleteAsset(nameBase, modelFileName){
  if(!confirm(`Delete model "${nameBase}" and its icon?`)) return;

  await deleteFileFromGitHub(`models/${modelFileName}`);
  await deleteFileFromGitHub(`icons/${nameBase}.png`);
  await updateManifest(); // Add this line
  loadAssets();
}

async function editAsset(nameBase){
  editingAsset = nameBase;
  const list = document.getElementById('assetList');
  list.innerHTML = ''; // show editing panel only for this asset

  const iconUrl = `https://raw.githubusercontent.com/${settings.username}/${settings.repo}/${settings.branch}/icons/${nameBase}.png`;
  const div = document.createElement('div');
  div.className = 'asset';
  div.style.flexDirection = 'column';
  div.innerHTML = `
    <strong>Editing: ${nameBase}</strong>
    <img src="${iconUrl}" style="margin-bottom:10px;" onerror="this.src='';">
    <div style="margin-bottom:10px;">
      <label>New Model (.fbx/.glb): <input id="editModelFile" type="file" accept=".fbx,.glb"></label>
      <label>New Icon (.png): <input id="editIconFile" type="file" accept=".png"></label>
      <div id="editDropArea" style="border:2px dashed #007bff; padding:10px; margin-top:10px; text-align:center; border-radius:6px; background:#f9f9f9;">
        Drag & drop model or icon here
      </div>
    </div>
    <button onclick="saveEdit()">Save</button>
    <button onclick="cancelEdit()">Cancel</button>
  `;
  list.appendChild(div);

  // Drag & drop for edit
  const dropArea = document.getElementById('editDropArea');
  ['dragenter', 'dragover'].forEach(eventName => {
    dropArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropArea.classList.add('drag-over');
    });
  });
  ['dragleave', 'drop'].forEach(eventName => {
    dropArea.addEventListener(eventName, (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropArea.classList.remove('drag-over');
    });
  });
  dropArea.addEventListener('drop', (e) => {
    let files = e.dataTransfer.files;
    let modelFileInput = document.getElementById('editModelFile');
    let iconFileInput = document.getElementById('editIconFile');
    for (let file of files) {
      if (file.name.endsWith('.fbx') || file.name.endsWith('.glb')) {
        modelFileInput.files = createFileList(file);
      } else if (file.name.endsWith('.png')) {
        iconFileInput.files = createFileList(file);
      }
    }
  });
}

function cancelEdit(){
  editingAsset = null;
  loadAssets();
}

async function saveEdit(){
  if(!editingAsset) return;
  let modelFile = document.getElementById('editModelFile').files[0];
  let iconFile = document.getElementById('editIconFile').files[0];
  if(!modelFile || !iconFile) { alert("Select both files"); return; }

  let nameBase = editingAsset;
  await deleteAsset(nameBase, nameBase + getFileExtension(modelFile.name));
  await uploadFileToGitHub(`models/${modelFile.name}`, modelFile);
  await uploadFileToGitHub(`icons/${iconFile.name}`, iconFile);

  alert("Edited successfully!");
  editingAsset = null;
  loadAssets();
}

async function uploadFileToGitHub(path, file){
  let content = await file.arrayBuffer();
  function arrayBufferToBase64(buffer) {
    let binary = '';
    let bytes = new Uint8Array(buffer);
    let chunkSize = 0x8000;
    for (let i = 0; i < bytes.length; i += chunkSize) {
      let chunk = bytes.subarray(i, i + chunkSize);
      binary += String.fromCharCode.apply(null, chunk);
    }
    return btoa(binary);
  }
  let base64data = arrayBufferToBase64(content);

  let url = `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/${path}`;
  let res = await fetch(url, {
    method: 'PUT',
    headers: {
      "Authorization": `token ${settings.token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Add ${path}`,
      content: base64data,
      branch: settings.branch
    })
  });
  if(!res.ok) {
    console.error(await res.text());
    alert("Error uploading " + path);
  }
}

async function deleteFileFromGitHub(path){
  let url = `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/${path}?ref=${settings.branch}`;
  let res = await fetch(url, {headers: {"Authorization": `token ${settings.token}`}});
  if(!res.ok) { console.error(await res.text()); return; }
  let data = await res.json();
  let sha = data.sha;

  res = await fetch(url, {
    method: 'DELETE',
    headers: {"Authorization": `token ${settings.token}`},
    body: JSON.stringify({message:`Delete ${path}`, sha: sha, branch: settings.branch})
  });
  if(!res.ok) { console.error(await res.text()); alert("Error deleting " + path); }
}

const dropArea = document.getElementById('dropArea');
['dragenter', 'dragover'].forEach(eventName => {
  dropArea.addEventListener(eventName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.add('drag-over');
  });
});
['dragleave', 'drop'].forEach(eventName => {
  dropArea.addEventListener(eventName, (e) => {
    e.preventDefault();
    e.stopPropagation();
    dropArea.classList.remove('drag-over');
  });
});
dropArea.addEventListener('drop', (e) => {
  let files = e.dataTransfer.files;
  let modelFileInput = document.getElementById('modelFile');
  let iconFileInput = document.getElementById('iconFile');
  for (let file of files) {
    if (file.name.endsWith('.fbx') || file.name.endsWith('.glb')) {
      modelFileInput.files = createFileList(file);
    } else if (file.name.endsWith('.png')) {
      iconFileInput.files = createFileList(file);
    }
  }
});

<!-- Add this function to your JavaScript -->
async function updateManifest() {
  if (!settings.username || !settings.repo) return;
  
  // Get current assets to build manifest
  let apiUrl = `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/models?ref=${settings.branch}`;
  let res = await fetch(apiUrl);
  let files = await res.json();
  
  let manifest = {
    version: "1.0",
    lastUpdated: new Date().toISOString(),
    assets: []
  };
  
  for (let f of files) {
    if (!f.name.endsWith('.fbx') && !f.name.endsWith('.glb')) continue;
    
    let nameBase = f.name.replace(/\.(fbx|glb)$/, '');
    let iconUrl = `https://raw.githubusercontent.com/${settings.username}/${settings.repo}/${settings.branch}/icons/${nameBase}.png`;
    let modelUrl = f.download_url;
    
    manifest.assets.push({
      name: nameBase,
      modelFile: f.name,
      modelUrl: modelUrl,
      iconUrl: iconUrl,
      size: f.size,
      lastModified: f.git_url ? await getFileCommitDate(f.git_url) : new Date().toISOString()
    });
  }
  
  // Upload manifest file
  await uploadManifestToGitHub(manifest);
}

async function getFileCommitDate(gitUrl) {
  try {
    let res = await fetch(gitUrl, {
      headers: {"Authorization": `token ${settings.token}`}
    });
    let data = await res.json();
    return data.committer.date;
  } catch (e) {
    return new Date().toISOString();
  }
}

async function uploadManifestToGitHub(manifest) {
  let content = JSON.stringify(manifest, null, 2);
  let base64data = btoa(unescape(encodeURIComponent(content)));
  
  let url = `https://api.github.com/repos/${settings.username}/${settings.repo}/contents/manifest.json`;
  
  // Check if manifest exists to get SHA
  let sha = null;
  try {
    let res = await fetch(url, {
      headers: {"Authorization": `token ${settings.token}`}
    });
    if (res.ok) {
      let data = await res.json();
      sha = data.sha;
    }
  } catch (e) {}
  
  let res = await fetch(url, {
    method: 'PUT',
    headers: {
      "Authorization": `token ${settings.token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update manifest.json",
      content: base64data,
      branch: settings.branch,
      sha: sha
    })
  });
  
  if (!res.ok) {
    console.error("Failed to update manifest:", await res.text());
  }
}

function createFileList(file) {
  const dataTransfer = new DataTransfer();
  dataTransfer.items.add(file);
  return dataTransfer.files;
}

loadSettings();
loadAssets();
</script>

</body>
</html>
